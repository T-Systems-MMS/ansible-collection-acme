---
### include/role 3 - validate challenge
- name: validate challenge only if it is created or changed
  when: challenge is changed
  block:
    - name: add a new TXT record to the SAN domains
      uri:
        url: "https://dns.hetzner.com/api/v1/records"
        method: POST
        body_format: json
        body:
          {
            "name": "_acme-challenge",
            "ttl": 60,
            "type": "TXT",
            "value": "{{ challenge['challenge_data'][item]['dns-01']['resource_value'] }}",
            "zone_id": "{{ acme_letsencrypt_domain.zone }}",
          }
        headers:
          Auth-API-Token: "{{ acme_letsencrypt_hetzner_auth_token }}"
      loop: "{{ acme_letsencrypt_domain.subject_alt_name }}"
      register: records
      when:
        - acme_letsencrypt_domain.subject_alt_name is defined
        # only runs if the challenge is run the first time, because then there is challenge_data
        - challenge['challenge_data'][item] is defined

    - name: Wait 20 seconds
      pause:
        seconds: 20

    - name: Let the challenge be validated and retrieve the cert and intermediate certificate
      acme_certificate:
        account_key_src: "{{ acme_letsencrypt_account_key_path }}"
        account_email: "{{ acme_letsencrypt_account_email }}"
        csr: "{{ acme_letsencrypt_csr_path }}"
        cert: "{{ acme_letsencrypt_cert_path }}"
        fullchain: "{{ acme_letsencrypt_fullchain_path }}"
        chain: "{{ acme_letsencrypt_intermediate_path }}"
        challenge: dns-01
        force: "{{ acme_letsencrypt_force_renewal | default(false) }}"
        acme_directory: "{{ acme_letsencrypt_directory }}"
        acme_version: 2
        terms_agreed: true
        remaining_days: "{{ acme_letsencrypt_remaining_days }}"
        data: "{{ challenge }}"

    - name: remove created SAN TXT records to keep DNS zone clean
      uri:
        url: "https://dns.hetzner.com/api/v1/records/{{ item }}"
        method: DELETE
        headers:
          Auth-API-Token: "{{ acme_letsencrypt_hetzner_auth_token }}"
      loop: "{{ records | json_query('results[*].json.record.id') }}"
      when:
        - acme_letsencrypt_domain.subject_alt_name is defined
        # only runs if the challenge is run the first time, because then there is challenge_data
        - item is defined
